trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VERSION: '1.9.5'
  ARM_CLIENT_ID: '$(servicePrincipalId)'
  ARM_CLIENT_SECRET: '$(servicePrincipalKey)'
  ARM_SUBSCRIPTION_ID: '$(subscriptionId)'
  ARM_TENANT_ID: '$(tenantId)'

stages:
# -------------------------------
# Apply Stage
# -------------------------------
- stage: Apply
  displayName: "Terraform Apply"
  jobs:
  - job: apply
    steps:
    - checkout: self
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '$(TF_VERSION)'

    - script: |
        az login --service-principal \
          -u $(servicePrincipalId) \
          -p $(servicePrincipalKey) \
          --tenant $(tenantId)
      displayName: "Azure Login"

    - script: |
        terraform init -input=false
        terraform plan -input=false -out=tfplan
        terraform apply -auto-approve tfplan
      displayName: 'Terraform Apply'

# -------------------------------
# Destroy Stage
# -------------------------------
- stage: Destroy
  displayName: "Terraform Destroy"
  dependsOn: Apply
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))  # manual runs only
  jobs:
  - job: destroy
    steps:
    - checkout: self
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '$(TF_VERSION)'

    - script: |
        az login --service-principal \
          -u $(servicePrincipalId) \
          -p $(servicePrincipalKey) \
          --tenant $(tenantId)
      displayName: "Azure Login"

    - script: |
        terraform init -input=false
        terraform destroy -auto-approve
      displayName: 'Terraform Destroy'