trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Terraform Azure credentials (from Azure Service Principal)
  ARM_CLIENT_ID: '$(servicePrincipalId)'
  ARM_CLIENT_SECRET: '$(servicePrincipalKey)'
  ARM_SUBSCRIPTION_ID: '$(subscriptionId)'
  ARM_TENANT_ID: '$(tenantId)'
  TF_VERSION: '1.9.5'     # Adjust to your Terraform version

stages:
- stage: Terraform
  displayName: "Provision Azure VM using Terraform"
  jobs:
  - job: terraform
    displayName: "Terraform Init, Plan, Apply"
    steps:
    - checkout: self

    # 1️⃣ Install Terraform
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '$(TF_VERSION)'

    # 2️⃣ Initialize Terraform
    - script: |
        terraform init -input=false
      displayName: 'Terraform Init'

    # 3️⃣ Plan Terraform changes
    - script: |
        terraform plan -input=false -out=tfplan
      displayName: 'Terraform Plan'

    # 4️⃣ Apply Terraform (auto-approve)
    - script: |
        terraform apply -input=false -auto-approve tfplan
      displayName: 'Terraform Apply'